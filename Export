import streamlit as st
import pandas as pd
import io
from data.retrieve_statbomb_data import get_statsbomb_player_season_stats

st.header("Export All StatsBomb Players by League & Position")

# Load the same data as the rest of your app
with st.spinner("Loading StatsBomb data..."):
    statsbomb_data = get_statsbomb_player_season_stats()

# Get unique leagues and positions
leagues = sorted(statsbomb_data['League'].dropna().unique())
positions = sorted(statsbomb_data['Position'].dropna().unique())

selected_league = st.selectbox("Select League", leagues)
selected_position = st.selectbox("Select Position", positions)

# Filter DataFrame
filtered = statsbomb_data[
    (statsbomb_data['League'] == selected_league) &
    (statsbomb_data['Position'] == selected_position)
]

if not filtered.empty:
    # Show all columns, or select a subset if you want
    st.dataframe(filtered, use_container_width=True)

    # Download as CSV
    csv = filtered.to_csv(index=False)
    st.download_button(
        label="Download as CSV",
        data=csv,
        file_name=f"{selected_league}_{selected_position}_statsbomb_players.csv",
        mime="text/csv"
    )

    # Download as Excel
    excel_buffer = io.BytesIO()
    with pd.ExcelWriter(excel_buffer, engine='xlsxwriter') as writer:
        filtered.to_excel(writer, index=False, sheet_name='Players')
        writer.save()
    excel_buffer.seek(0)
    st.download_button(
        label="Download as Excel",
        data=excel_buffer,
        file_name=f"{selected_league}_{selected_position}_statsbomb_players.xlsx",
        mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
    )
else:
    st.warning("No players found for this league and position.")
